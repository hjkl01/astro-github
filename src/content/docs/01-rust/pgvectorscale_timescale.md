---
title: pgvectorscale
---

# pgvectorscale

pgvectorscale 是 PostgreSQL 的向量数据扩展，基于 pgvector，提供高性能嵌入搜索和成本高效的存储，适用于 AI 应用。

## 功能

- **StreamingDiskANN 索引**：基于 Microsoft DiskANN 算法的新索引类型，用于近似最近邻查询。
- **统计二进制量化 (SBQ)**：Timescale 研究开发的压缩方法，提高标准二进制量化的性能。
- **标签过滤向量搜索**：基于 Microsoft Filtered DiskANN 研究，结合向量相似性搜索和标签过滤，实现更精确高效的结果。
- 支持余弦距离 (cosine)、L2 距离和内积查询。
- 并行索引构建，提高大型数据集性能。
- 查询时参数调优，平衡准确性和速度。

## 用法

### 安装

#### 使用 Docker

1. 运行 TimescaleDB Docker 镜像。
2. 连接数据库：`psql -d "postgres://<username>:<password>@<host>:<port>/<database-name>"`
3. 创建扩展：`CREATE EXTENSION IF NOT EXISTS vectorscale CASCADE;`

#### 从源码安装

1. 安装 Rust 和依赖。
2. 克隆仓库：`git clone https://github.com/timescale/pgvectorscale`
3. 构建并安装：`cargo pgrx install --release`
4. 创建扩展。

### 基本使用

1. 创建表：

   ```sql
   CREATE TABLE document_embedding (
       id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
       metadata JSONB,
       contents TEXT,
       embedding VECTOR(1536)
   );
   ```

2. 创建 StreamingDiskANN 索引：

   ```sql
   CREATE INDEX document_embedding_idx ON document_embedding
   USING diskann (embedding vector_cosine_ops);
   ```

3. 查询最近邻：
   ```sql
   SELECT * FROM document_embedding
   ORDER BY embedding <=> $1
   LIMIT 10;
   ```

### 标签过滤

1. 创建带标签的表：

   ```sql
   CREATE TABLE documents (
       id SERIAL PRIMARY KEY,
       embedding VECTOR(1536),
       labels SMALLINT[]
   );
   ```

2. 创建带标签的索引：

   ```sql
   CREATE INDEX ON documents USING diskann (embedding vector_cosine_ops, labels);
   ```

3. 过滤查询：
   ```sql
   SELECT * FROM documents
   WHERE labels && ARRAY[1, 3]
   ORDER BY embedding <=> '[...]'
   LIMIT 10;
   ```

### 调优

- 索引构建参数：如 `num_neighbors`、`storage_layout` 等。
- 查询参数：`diskann.query_rescore`、`diskann.query_search_list_size`。

更多详情请参考 [官方文档](https://github.com/timescale/pgvectorscale)。
